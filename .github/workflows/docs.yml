name: Build & Deploy Docs

on:
  push:
    branches: [main]            # ä¸»åˆ†æ”¯å˜åŠ¨è§¦å‘
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'
  workflow_dispatch:            # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write               # éœ€è¦æ¨é€ gh-pages åˆ†æ”¯

jobs:
  build-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0        # æ¨é€ gh-pages éœ€è¦å®Œæ•´å†å²

      - name: Setup Node (for redoc-cli)
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install documentation tools
        run: |
          npm install -g redoc-cli@latest
          sudo apt-get update -y && sudo apt-get install -y pandoc

      - name: Build static HTML docs
        run: |
          mkdir -p public
          # ç”Ÿæˆ API å‚è€ƒ
          redoc-cli bundle docs/Acunetix-API-Documentation.yaml -o public/api-reference.html

          # ç”Ÿæˆ CLI æ‰‹å†Œ HTML
          pandoc docs/awvs_cli_usage.md -f markdown -t html5 -s \
                 --metadata title="AWVS CLI ä½¿ç”¨æŒ‡å—" \
                 -c https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css \
                 -o public/cli-usage.html

          # ç”Ÿæˆé¦–é¡µ
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Acunetix Python SDK æ–‡æ¡£</title>
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css" />
          </head>
          <body>
            <div class="wrapper markdown-body">
              <h1>Acunetix Python SDK æ–‡æ¡£ä¸­å¿ƒ</h1>
              <p>æ¬¢è¿è®¿é—® <strong>Acunetix Python SDK</strong> çš„åœ¨çº¿æ–‡æ¡£ã€‚</p>
              <h2>å¯ç”¨æ–‡æ¡£</h2>
              <div class="card">
                <h3>ğŸ”§ AWVS CLI ä½¿ç”¨æŒ‡å—</h3>
                <p>å‘½ä»¤è¡Œå·¥å…·è¯¦ç»†ä½¿ç”¨æ–¹æ³•ï¼Œæ¶µç›–ç›®æ ‡ã€æ‰«æã€æŠ¥å‘Šç­‰æ“ä½œã€‚</p>
                <a class="btn" href="cli-usage.html">æŸ¥çœ‹ CLI æŒ‡å—</a>
              </div>
              <div class="card">
                <h3>ğŸ“˜ API å‚è€ƒæ–‡æ¡£</h3>
                <p>åŸºäºå®˜æ–¹ OpenAPI è§„èŒƒç”Ÿæˆçš„å®Œæ•´ API ç«¯ç‚¹å‚è€ƒã€‚</p>
                <a class="btn" href="api-reference.html">æµè§ˆ API å‚è€ƒ</a>
              </div>
              <hr />
              <p>æºä»£ç ä»“åº“ï¼š<a href="https://github.com/Explorer1092/acunetix_sdk">Explorer1092/acunetix_sdk</a></p>
            </div>
          </body>
          </html>
          EOF

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          force_orphan: true      # æ¯æ¬¡ç”¨å¹²å‡€å†å²
